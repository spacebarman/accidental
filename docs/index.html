<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RLZFCJDSHT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RLZFCJDSHT');
    </script>
    <title>Accidental</title>
    <style>
      @font-face {
        font-family: 'BarlowCondensed';
        src: url('fonts/BarlowCondensed-Medium.ttf') format('truetype');
      }
      @font-face {
        font-family: 'Rubik';
        src: url('fonts/Rubik-VariableFont_wght.ttf') format('truetype');
        font-weight: 100 900;
      }
      :root {
        --grid-size: 80vmin;
        --brand-size: calc(var(--grid-size) * 0.035);
      }

      html,
      body {
        margin: 0;
        width: 100vw;
        height: 100vh;
        background: #000;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "BarlowCondensed", sans-serif;
      }

      .player {
        position: relative;
        width: var(--grid-size);
        display: flex;
        flex-direction: column;
      }

      .brand {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-top: calc(var(--brand-size) * 0.1);
        font-size: var(--brand-size);
        letter-spacing: 0.02em;
        line-height: 1;
        color: #666666;
        text-transform: uppercase;
        position: relative;
      }

      .view-toggle {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        margin: 0;
        color: #666666;
        font-family: "BarlowCondensed", sans-serif;
        font-size: var(--brand-size);
        letter-spacing: 0.02em;
        line-height: 1;
        transition: color 150ms linear;
        display: flex;
        align-items: center;
      }

      .view-toggle img {
        height: 0.8em;
        width: auto;
        opacity: 0.7;
        transition: opacity 150ms linear;
      }

      .view-toggle svg {
        height: 0.8em;
        width: auto;
        opacity: 0.7;
        transition: opacity 150ms linear;
      }

      .view-toggle:hover img {
        opacity: 1;
      }

      .view-toggle:hover svg {
        opacity: 1;
      }

      .play-toggle {
        font-size: var(--brand-size);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        padding: 0;
      }

      .play-toggle img {
        height: 0.9em;
        width: auto;
      }

      .grid {
        width: 100%;
        height: var(--grid-size);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
      }

      .cell {
        position: relative;
        overflow: hidden;
        transition: opacity 150ms linear;
        filter: brightness(0.7);
        cursor: pointer;
      }

      .cell-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        transition: transform 0.15s ease-out;
      }

      .cell:hover {
        opacity: 0.5;
      }

      .cell.active:hover {
        opacity: 1;
      }

      .cell.active {
        filter: brightness(1);
      }

      .cell.active::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        box-shadow: inset 0 0 40px 20px #fff;
        pointer-events: none;
        z-index: 1;
      }

      .cell.next {
        animation: nextPulse 2s ease-in-out infinite;
      }

      @keyframes nextPulse {
        0%,
        100% {
          filter: brightness(.3);
        }
        50% {
          filter: brightness(.8);
        }
      }

      .hidden {
        display: none;
      }

      .progress {
        width: 100%;
        height: 8px;
        background: #3c3c3c;
        opacity: 0;
        transition: opacity 150ms linear;
      }

      .progress.is-visible {
        opacity: 1;
      }

      .progress-fill {
        width: 0%;
        height: 100%;
        background: #adadad;
        transition: width 0.15s linear;
      }

      a {
        color: #eeeeee;
      }

      .brand a {
        color: #666666;
        text-decoration: none;
      }

      .brand a:hover {
        color: #bbbbbb;
      }

      #controls {
        display: flex;
        direction: row;
        gap: .5em;
        align-items: center;
      } 

      .info-dialog {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--grid-size);
        background: rgba(34, 34, 34, .8);
        color: #cccccc;
        z-index: 10;
        display: none;
        padding: 3%;
        box-sizing: border-box;
        font-family: 'Rubik', sans-serif;
        font-size: calc(var(--grid-size) * 0.025);
        line-height: 1.6;
      }

      .info-dialog.visible {
        display: block;
      }

      .info-scroll-wrapper {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        padding-right: 2%;
      }

      .info-close {
        background: #222222;
        border: 1px solid #cccccc;
        color: #cccccc;
        padding: 0.55em 1em;
        cursor: pointer;
        font-family: "BarlowCondensed", sans-serif;
        font-size: 1em;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 150ms linear;
        z-index: 1;
        margin-right: 1em;
      }

      .info-close:hover {
        background: #cccccc;
        color: #222222;
      }

      .info-controls {
        position: absolute;
        top: 3%;
        right: 3%;
        display: flex;
        gap: 1em;
        align-items: center;
        z-index: 2;
      }

      .language-selector {
        background: #222222;
        border: 1px solid #cccccc;
        color: #cccccc;
        padding: 0.5em 0.8em;
        cursor: pointer;
        font-family: "BarlowCondensed", sans-serif;
        font-size: 1em;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 150ms linear;
        box-sizing: border-box;
        margin: 0;
      }

      .language-selector:hover {
        background: #cccccc;
        color: #222222;
      }

      .language-selector option {
        background: #222222;
        color: #666666;
      }

      .cover-view {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--grid-size);
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: none;
        z-index: 5;
        cursor: pointer;
        overflow: hidden;
      }

      .cover-view.visible {
        display: block;
      }

      @media (max-width: 768px) {
        :root {
          --grid-size: 95vmin;
        }

        body {
          overflow-y: hidden;
          align-items: flex-start;
          justify-content: center;
          padding-top: calc(min(100vw, 100vh) * 0.025);
        }

        .brand {
          font-size: calc(var(--brand-size) * 1.5);
        }

        .view-toggle {
          font-size: calc(var(--brand-size) * 1.5);
        }

        .info-dialog {
          font-size: calc(var(--grid-size) * 0.03);
        }
      }

      @media (max-width: 768px) and (orientation: landscape) {
        :root {
          --grid-size: 80vmin;
        }

        body {
          overflow-y: hidden;
          align-items: flex-start;
          justify-content: center;
          padding-top: calc(min(100vw, 100vh) * 0.025);
        }

        .brand {
          font-size: calc(var(--brand-size) * 1.5);
        }

        .view-toggle {
          font-size: calc(var(--brand-size) * 1.5);
        }

        .info-dialog {
          font-size: calc(var(--grid-size) * 0.03);
        }

      }
    </style>
  </head>
  <body>
    <div class="player">
      <div class="cover-view" id="coverView"></div>
      <div class="grid" id="grid">
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb01.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb02.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb03.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb04.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb05.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb06.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb07.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb08.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb09.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb10.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb11.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb12.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb13.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb14.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb15.jpg')"></div></div>
        <div class="cell"><div class="cell-image" style="background-image: url('images/thumbnails/Spacebarman-Accidental-thumb16.jpg')"></div></div>
      </div>
      <div class="info-dialog" id="infoDialog">
        <div class="info-controls">
          <select id="languageSelector" class="language-selector">
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="ca">Català</option>
          </select>
          <button class="info-close" id="infoClose">Close</button>
        </div>
        <div class="info-scroll-wrapper">
          <div class="info-content" id="infoContent">
          </div>
        </div>
      </div>
      <div class="progress" id="progress">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="brand">
        <div>
          <span>
            <a href="https://spacebarman.bandcamp.com/album/accidental" target="_blank" rel="noreferrer noopener">SPACEBARMAN · ACCIDENTAL</a>
          </span>
        </div>

        <div id="controls">
          <button class="view-toggle play-toggle" id="playToggle" aria-pressed="false" aria-label="Play" title="Play / pause audio">
            <img src="images/icon-play.svg" alt="Play" width="16" height="16">
          </button>
            <button class="view-toggle" id="nextToggle" aria-label="Next track" title="Play next track">
              <img src="images/icon-next.svg" alt="Next track" width="16" height="16">
            </button>
            <button class="view-toggle" id="infoToggle" aria-label="Open info" title="Show info">
              <img src="images/icon-info.svg" alt="Info" width="16" height="16">
            </button>
            <button class="view-toggle" id="viewToggle" title="Toggle cover/grid view">
              <img src="images/icon-cover.svg" alt="Toggle view" width="16" height="16">
            </button>
        </div>
      </div>
    </div>

    <script>
      const playlist = [
        "mp3/Spacebarman-Accidental-Song01.mp3",
        "mp3/Spacebarman-Accidental-Song02.mp3",
        "mp3/Spacebarman-Accidental-Song03.mp3",
        "mp3/Spacebarman-Accidental-Song04.mp3",
        "mp3/Spacebarman-Accidental-Song05.mp3",
        "mp3/Spacebarman-Accidental-Song06.mp3",
        "mp3/Spacebarman-Accidental-Song07.mp3",
        "mp3/Spacebarman-Accidental-Song08.mp3",
        "mp3/Spacebarman-Accidental-Song09.mp3",
        "mp3/Spacebarman-Accidental-Song10.mp3",
        "mp3/Spacebarman-Accidental-Song11.mp3",
        "mp3/Spacebarman-Accidental-Song12.mp3",
        "mp3/Spacebarman-Accidental-Song13.mp3",
        "mp3/Spacebarman-Accidental-Song14.mp3",
        "mp3/Spacebarman-Accidental-Song15.mp3",
        "mp3/Spacebarman-Accidental-Song16.mp3",
      ];

      const translations = {
        en: {
          closeBtn: "Close",
          instructions: "INSTRUCTIONS",
          bandcampLink: "Get this album on Bandcamp",
          instructionsText: "Just click on any tile! Songs will play in random order. Currently playing song will be highlighted, while the next one will blink.",
          aboutAlbum: "ABOUT <i>ACCIDENTAL</i>",
          aboutAlbumP1: "In a time where everything seems to revolve around chatting with AI machines, this album of small instrumentals is an attempt to convey meaning without words*. Its songs were indeed the result of a conversation, but in this case with a few guitar pedals**, a conversation made of knob positions, footswitch pressing, guitar riffs, listening, and pondering. To align with this wordless dialog, songs don't have individual names, they are only numbered for the sake of referencing the resulting audio files.",
          aboutAlbumP2: "The album was recorded through a few meditative sessions between November and October of 2025. In those sessions, I prioritised spontaneity, trying to restrain my “producer” self from intervening and polishing, instead, allowing exploration and surprise to come through. In some cases, however, the explorer in me wanted to add a bit extra structure, and that was ok.",
          aboutAlbumP3: "Melodies, harmonies or rhythmical patterns were spontaneous responses inspired by accidental noises and sound textures. I captured those textures from multiple sources: unexpected electrical noises***, degraded drones, or loops downtuned beyond recognition. I then acted as an interlocutor, evaluating those abstract sound prompts and replying with musical passages on top, around, or despite them. The result is the set of lucky sonic accidents you can listen to here.",
          aboutAlbumP4: "The album is an appreciation of texture in both sound and visual form. The artworks are abstract photographs I've took in the last few years, macro captures of small worlds or surprising textures from simple everyday things. I hope you enjoy the images as much as the music.",
          notes: "NOTES",
          notesText: "* Almost. The album has a title, after all. Also this info text is the most I've ever written about one of my musical works.<br/>** For the guitar geeks, I used almost exclusively <a href=\"https://www.chasebliss.eu/lost-and-found\" target=\"_blank\">ChaseBliss' Lost+Found</a>, <a href=\"https://empresseffects.com/products/zoia\" target=\"_blank\">Empress Effects' Zoia</a> and <a href=\"https://line6.com/hx-stomp/\" target=\"_blank\">Line6 HX Stomp</a>. L+F was my master texture generator. With the Zoia, I programmed a very interactive stereo looper that allowed me to mangle loops and the live signal separately. I used the HX Stomp only for amp+cab simulation. Oh, I also used <a href=\"https://banananaeffects.com/products/abracadabra\" target=\"_blank\">Banana's Abracadabra</a> in one song. Can you guess which one?<br/>*** If I don't play my guitar, my pedalboard spontaneously produces ghostly, bell-like sounds at random intervals. They're beautiful."
        },
        es: {
          closeBtn: "Cerrar",
          instructions: "INSTRUCCIONES",
          bandcampLink: "Compra este álbum en Bandcamp",
          instructionsText: "¡Solo haz clic en cualquier imagen! Las canciones se reproducirán en orden aleatorio. La canción que se está reproduciendo actualmente será resaltada, mientras que la siguiente parpadeará.",
          aboutAlbum: "ACERCA DE <i>ACCIDENTAL</i>",
          aboutAlbumP1: "En una época en la que todo parece girar en torno a charlar con máquinas de IA, este álbum de pequeñas canciones instrumentales es un intento de transmitir significado sin usar palabras*. Sus canciones son en efecto el resultado de una conversación, pero en este caso con algunos pedales de guitarra**, una conversación hecha de posiciones de potenciómetros, opresión de footswitches, riffs de guitarra, escucha y reflexión. En consistencia con este diálogo sin palabras, las canciones no tienen nombres individuales, solo están numeradas para poder referenciar los archivos de audio resultantes.",
          aboutAlbumP2: "El álbum fue grabado durante algunas sesiones meditativas entre noviembre y octubre de 2025. En esas sesiones, prioricé la espontaneidad, intentando evitar que mi yo \"productor\" interveniniera y puliera de más, y en su lugar permitiendo que la exploración y la sorpresa salieran a la luz. Sin embargo, en algunos casos, el explorador en mí quiso agregar un poco de estructura extra, y eso estuvo bien.",
          aboutAlbumP3: "Las melodías, armonías o patrones rítmicos fueron respuestas espontáneas inspiradas en ruidos accidentales y texturas sonoras. Capturé esas texturas de múltiples fuentes: ruidos eléctricos inesperados***, drones degradados o loops desafinados hasta quedar irreconocibles. Luego actué como un interlocutor, evaluando esos sonidos abstractos y respondiendo con pasajes musicales encima, alrededor, o a pesar de ellos. El resultado es el conjunto de accidentes afortunados que puedes escuchar aquí.",
          aboutAlbumP4: "El álbum es una apreciación de la textura tanto en forma sonora como visual. Los artes de portada son fotografías abstractas que he tomado en los últimos años, capturas macro de pequeños mundos o texturas sorprendentes de cosas cotidianas. Espero que disfrutes tanto de las imágenes como de la música.",
          notes: "NOTAS",
          notesText: "* Casi. El álbum tiene un título, después de todo. Además, este texto de información es lo más que he escrito sobre uno de mis trabajos musicales.<br/>** Para los aficionados a la guitarra, utilicé casi exclusivamente <a href=\"https://www.chasebliss.eu/lost-and-found\" target=\"_blank\">ChaseBliss' Lost+Found</a>, <a href=\"https://empresseffects.com/products/zoia\" target=\"_blank\">Empress Effects' Zoia</a> y <a href=\"https://line6.com/hx-stomp/\" target=\"_blank\">Line6 HX Stomp</a>. L+F fue mi generador de texturas maestro. Con la Zoia, programé un looper estéreo muy interactivo que me permitió manipular bucles y la señal en vivo por separado. Utilicé el HX Stomp solo para simulación de amplificador + gabinete. Oh, también usé <a href=\"https://banananaeffects.com/products/abracadabra\" target=\"_blank\">Banana's Abracadabra</a> en una canción. ¿Puedes adivinar cuál?<br/>*** Sin tocar yo guitrarra, mi pedalera produce, de manera espontánea y aleatoria, sonidos de campanas fantasmales. Son muy bonitos."
        },
        ca: {
          closeBtn: "Tancar",
          instructions: "INSTRUCCIONS",
          bandcampLink: "Compra aquest àlbum a Bandcamp",
          instructionsText: "Només fes clic a qualsevol imatge! Les cançons es reproduiran en ordre aleatori. La cançó que s'està reproduint actualment serà ressaltada, mentre que la següent parpellejarà.",
          aboutAlbum: "SOBRE <i>ACCIDENTAL</i>",
          aboutAlbumP1: "En una època en què tot sembla girar al voltant de xerrar amb màquines d'IA, aquest àlbum de petits cancions instrumentals és un intent de transmetre significat sense paraules*. Les seves cançons van ser en efecte el resultat d'una conversa, però en aquest cas amb alguns pedals de guitarra**, una conversa feta de posicions de potenciòmetres, pressió de footswitches, riffs de guitarra, escolta i reflexió. En concordança amb aquest diàleg sense paraules, les cançons no tenen noms individuals, només estan numerades per facilitar la referència dels arxius d'àudio resultants.",
          aboutAlbumP2: "L'àlbum va ser gravat a través de diverses sessions meditatives entre novembre i octubre de 2025. En aquestes sessions, vaig prioritzar l'espontaneïtat, fent un esforç per contenir el meu jo \"productor\" per intervenir i polir, i en lloc d'això permetre que l'exploració i la sorpresa sortissin a la llum. Tanmateix, en alguns casos, l'explorador dins meu volia afegir una mica d'estructura extra, i això estava bé.",
          aboutAlbumP3: "Les melodies, harmonies o patrons rítmics van ser respostes espontànies inspirades en sorolls accidentals i textures sonores. Vaig capturar aquestes textures de múltiples fonts: sorolls elèctrics inesperats***, drones degradats o loops desafinats més enllà del reconeixement. Llavors vaig actuar com a interlocutor, avaluant aquests sons abstractes i responent amb passatges musicals a sobre, al voltant o malgrat d'ells. El resultat és el conjunt d'accidents afortunats que podeu escoltar aquí.",
          aboutAlbumP4: "L'àlbum és una apreciació de la textura tant en forma sonora com visual. Les arts de coberta són fotografies abstractes que he pres en els últims anys, captures macro de petit mons o textures sorprenents de coses quotidianes. Espero que gaudiu tant de les imatges com de la música.",
          notes: "NOTES",
          notesText: "* Gairebé. L'àlbum té un títol, després de tot. A més, aquest text informatiu és el més que he escrit sobre una de les meves obres musicals.<br/>** Per als aficionats a la guitarra, vaig utilitzar gairebé exclusivament <a href=\"https://www.chasebliss.eu/lost-and-found\" target=\"_blank\">ChaseBliss' Lost+Found</a>, <a href=\"https://empresseffects.com/products/zoia\" target=\"_blank\">Empress Effects' Zoia</a> i <a href=\"https://line6.com/hx-stomp/\" target=\"_blank\">Line6 HX Stomp</a>. L+F va ser el meu generador de textures mestre. Amb la Zoia, vaig programar un looper estèreo molt interactiu que em va permetre manipular bucles i el senyal en viu per separat. Vaig utilitzar el HX Stomp només per a la simulació d'amplificador + gabinet. Ah, també vaig utilitzar <a href=\"https://banananaeffects.com/products/abracadabra\" target=\"_blank\">Banana's Abracadabra</a> en una cançó. Pots endevinar quina?<br/>*** Sense tocar jo guitrarra, la meva pedalera produeix, de manera espontània i aleatòria, sons de campanes fantasmals. Són molt bonics."
        }
      };

      let currentLanguage = "en";

      function renderInfoContent() {
        const t = translations[currentLanguage];
        const infoContent = document.getElementById('infoContent');
        infoContent.innerHTML = `
          <p><a href="https://spacebarman.bandcamp.com/album/accidental" target="_blank" rel="noreferrer noopener">${t.bandcampLink}</a></p>
          <h3>${t.instructions}</h3>
          <p>${t.instructionsText}</p>
          <h3>${t.aboutAlbum}</h3>
          <p>${t.aboutAlbumP1}</p>
          <p>${t.aboutAlbumP2}</p>
          <p>${t.aboutAlbumP3}</p>
          <p>${t.aboutAlbumP4}</p>
          <h3>${t.notes}</h3>
          <p>${t.notesText}</p>
          <p><a href="https://www.spacebarman.com" target="_blank" rel="noreferrer">www.spacebarman.com</a></p>
        `;
      }

      function updateCloseButtonText() {
        const closeBtn = document.getElementById('infoClose');
        closeBtn.textContent = translations[currentLanguage].closeBtn;
      }

      const audio = new Audio();

      const cells = Array.from(document.querySelectorAll(".cell"));
      const progress = document.getElementById("progress");
      const progressFill = document.getElementById("progressFill");

      // Cover view functionality - declare early to avoid initialization errors
      const coverView = document.getElementById('coverView');
      const viewToggle = document.getElementById('viewToggle');
      const viewToggleImg = viewToggle.querySelector('img');
      const playToggle = document.getElementById('playToggle');
      const playToggleImg = playToggle ? playToggle.querySelector('img') : null;
      const nextToggle = document.getElementById('nextToggle');
      let coverViewActive = false;

      function updatePlayToggleIcon(isPlaying) {
        if (!playToggle) {
          return;
        }
        playToggle.setAttribute('aria-label', isPlaying ? 'Pause' : 'Play');
        playToggle.setAttribute('aria-pressed', isPlaying);
        if (playToggleImg) {
          playToggleImg.src = isPlaying ? 'images/icon-pause.svg' : 'images/icon-play.svg';
          playToggleImg.alt = isPlaying ? 'Pause' : 'Play';
        }
      }

      updatePlayToggleIcon(false);

      function updateCoverArt(index) {
        const coverPath = `images/coverarts/Spacebarman-Accidental-coverart${(index + 1).toString().padStart(2, '0')}.jpg`;
        coverView.style.backgroundImage = `url('${coverPath}')`;
      }

      function toggleViewMode() {
        coverViewActive = !coverViewActive;
        coverView.classList.toggle('visible');
        viewToggleImg.src = coverViewActive ? 'images/icon-grid.svg' : 'images/icon-cover.svg';
        if (coverViewActive && audio.src) {
          updateCoverArt(activeIndex);
        }
      }

      let hasStarted = false;
      let activeIndex = 0;
      let activeCell = null;
      let nextCell = null;
      let nextIndex = 0;
      let queue = [];
      let queueIndex = 0;

      function generateShuffledQueue(firstIndex) {
        const shuffled = [];
        const remaining = [];
        for (let i = 0; i < playlist.length; i++) {
          if (i !== firstIndex) {
            remaining.push(i);
          }
        }
        for (let i = remaining.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
        }
        shuffled.push(firstIndex);
        shuffled.push(...remaining);
        return shuffled;
      }

      function showUi() {
        if (!hasStarted) {
          progress.classList.add("is-visible");
          hasStarted = true;
        }
      }

      function setActiveCell(index) {
        if (activeCell) {
          activeCell.classList.remove("active");
        }

        activeCell = cells[index];
        activeCell.classList.add("active");
      }

      function clearNextCell() {
        if (nextCell) {
          nextCell.classList.remove("next");
          nextCell = null;
        }
      }

      function setNextCell(index) {
        clearNextCell();
        nextIndex = index;
        nextCell = cells[index];
        nextCell.classList.add("next");
      }

      function getRandomNextIndex() {
        if (playlist.length <= 1) {
          return activeIndex;
        }

        let nextIndex = activeIndex;
        while (nextIndex === activeIndex) {
          nextIndex = Math.floor(Math.random() * playlist.length);
        }

        return nextIndex;
      }

      function playTrack(index) {
        if (activeCell) {
          const img = activeCell.querySelector('.cell-image');
          if (img) img.style.transform = 'scale(1) rotate(0deg)';
        }
        activeIndex = index;
        setActiveCell(index);
        clearNextCell();
        progressFill.style.width = "0%";
        if (activeCell) {
          const img = activeCell.querySelector('.cell-image');
          if (img) img.style.transform = 'scale(1) rotate(0deg)';
        }
        audio.src = playlist[index];
        audio.currentTime = 0;
        audio.play();
        showUi();
        if (queue.length > queueIndex + 1) {
          setNextCell(queue[queueIndex + 1]);
        }
        updateCoverArt(index);
      }

      function playNextTrack() {
        if (!queue.length) {
          return;
        }
        queueIndex++;
        if (queueIndex >= queue.length) {
          queueIndex = 0;
          queue = generateShuffledQueue(queue[0]);
        }
        playTrack(queue[queueIndex]);
      }

      cells.forEach((cell, index) => {
        cell.addEventListener("click", () => {
          if (hasStarted && index === activeIndex) {
            if (audio.paused) {
              audio.play();
            } else {
              audio.pause();
            }
            return;
          }

          queue = generateShuffledQueue(index);
          queueIndex = 0;
          playTrack(index);
        });
      });

      audio.addEventListener("timeupdate", () => {
        if (!Number.isFinite(audio.duration) || audio.duration <= 0) {
          progressFill.style.width = "0%";
          return;
        }

        const progressValue = (audio.currentTime / audio.duration) * 100;
        progressFill.style.width = `${progressValue}%`;

        if (activeCell) {
          const scaleValue = 1 + (progressValue * 0.1);
          const rotateValue = (progressValue / 100) * 45;
          const img = activeCell.querySelector('.cell-image');
          if (img) {
            img.style.transform = `scale(${scaleValue}) rotate(${rotateValue}deg)`;
          }
        }
      });

      audio.addEventListener("ended", () => {
        queueIndex++;
        if (queueIndex >= queue.length) {
          queueIndex = 0;
          queue = generateShuffledQueue(queue[0]);
        }
        playTrack(queue[queueIndex]);
      });

      audio.addEventListener("play", () => {
        if (activeCell) {
          activeCell.classList.add("active");
        }
        progress.classList.add("is-visible");
        if (queue.length > queueIndex + 1) {
          setNextCell(queue[queueIndex + 1]);
        }
        updatePlayToggleIcon(true);
      });

      audio.addEventListener("pause", () => {
        if (activeCell) {
          activeCell.classList.remove("active");
        }
        progress.classList.remove("is-visible");
        clearNextCell();
        updatePlayToggleIcon(false);
      });

      // Initialize with a shuffled queue on page load
      const initialFirstIndex = Math.floor(Math.random() * playlist.length);
      queue = generateShuffledQueue(initialFirstIndex);
      queueIndex = 0;
      if (queue.length > 1) {
        setNextCell(queue[1]);
        updateCoverArt(queue[1]);
      }

      // Info dialog functionality
      const infoDialog = document.getElementById('infoDialog');
      const infoClose = document.getElementById('infoClose');
      const infoToggle = document.getElementById('infoToggle');

      if (infoToggle) {
        infoToggle.addEventListener('click', () => {
          infoDialog.classList.toggle('visible');
        });
      }

      infoClose.addEventListener('click', () => {
        infoDialog.classList.remove('visible');
      });

      // Language selector
      const languageSelector = document.getElementById('languageSelector');
      
      // Load saved language from localStorage
      const savedLanguage = localStorage.getItem('accidental-language');
      if (savedLanguage && translations[savedLanguage]) {
        currentLanguage = savedLanguage;
        languageSelector.value = savedLanguage;
      }
      
      languageSelector.addEventListener('change', (e) => {
        currentLanguage = e.target.value;
        localStorage.setItem('accidental-language', currentLanguage);
        renderInfoContent();
        updateCloseButtonText();
      });

      // Initialize info content
      renderInfoContent();
      updateCloseButtonText();

      viewToggle.addEventListener('click', toggleViewMode);
      playToggle.addEventListener('click', () => {
        if (!audio.src) {
          queue = generateShuffledQueue(nextIndex);
          queueIndex = 0;
          playTrack(nextIndex);
          return;
        }

        if (audio.paused) {
          audio.play();
        } else {
          audio.pause();
        }
      });
      if (nextToggle) {
        nextToggle.addEventListener('click', playNextTrack);
      }

      coverView.addEventListener('click', () => {
        if (audio.paused) {
          audio.play();
        } else {
          audio.pause();
        }
      });

      // Keyboard interaction
      document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
          e.preventDefault();
          if (!audio.src) {
              queue = generateShuffledQueue(nextIndex);
              queueIndex = 0;
              playTrack(nextIndex);
          } else if (audio.paused) {
            audio.play();
          } else {
            audio.pause();
          }
        } else if (e.key === 'Escape') {
          infoDialog.classList.remove('visible');
        } else if (e.key === 'i' || e.key === 'I') {
          infoDialog.classList.toggle('visible');
        } else if (e.key === 'c' || e.key === 'C') {
          toggleViewMode();
        } else if (e.key === 'n' || e.key === 'N') {
          playNextTrack();
        }
      });

    </script>
  </body>
</html>
